{% load static %}


{% block content %}
<link rel="stylesheet" href="{% static 'css/detail.css' %}">
<title>Book page</title>
<div class="container">
    <!-- Mensagens de erro/sucesso -->
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' %}
                <div class="error-message">{{ message }}</div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <!-- Header do Livro -->
    <div class="book-header">
        <div class="book-cover">
            {% if book.cover %}
                <img src="{{ book.cover.url }}" alt="{{ book.title }}">
            {% else %}
                <div class="no-cover">
                    Sem capa
                </div>
            {% endif %}
        </div>
        
        <div class="book-info">
            <h1 class="book-title">{{ book.title }}</h1>
            
            <div class="book-meta">
                <p><strong>Autor:</strong> {{ book.author }}</p>
                <p><strong>Publicado em:</strong> {{ book.publication_date|date:"d/m/Y" }}</p>
            </div>
            
            <div class="tags">
                <strong>Tags:</strong> 
                {% for tag in book.tags.all %}
                    <a href="{% url 'virtuallibrary:book_list_by_tag' tag.slug %}">{{ tag.name }}</a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Descrição do Livro -->
    <div class="book-description">
        {{ book.body|linebreaks }}
    </div>

    <!-- Seção de Empréstimo -->
    {% if user.is_authenticated %}
        <div class="borrow-section">
            <button id="btn-emprestar" 
                    class="borrow-btn" 
                    style="cursor: pointer; border: none; font-size: 16px;"
                    data-book-id="{{ book.id }}" 
                    data-username="{{ user.username }}">
                Pegar emprestado
            </button>
        </div>
    {% endif %}

    <!-- Livros Similares -->
    <div class="similar-books-section">
        <h2 class="similar-books-title">Livros similares</h2>
        
        {% if similar_books %}
            <div class="similar-books-grid">
                {% for similar_book in similar_books %}
                    <div class="similar-book-item">
                        <a href="{{ similar_book.get_absolute_url }}">
                            {% if similar_book.cover %}
                                <img src="{{ similar_book.cover.url }}" alt="{{ similar_book.title }}">
                            {% else %}
                                <div class="no-cover">
                                    Sem capa
                                </div>
                            {% endif %}
                            <div class="similar-book-title">
                                {{ similar_book.title }}
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-similar-books">
                <p>Não há livros similares disponíveis no momento.</p>
            </div>
        {% endif %}
    </div>
</div>
<script>
    document.getElementById('btn-emprestar').addEventListener('click', async function() {
        const btn = this;
        const bookId = btn.getAttribute('data-book-id');
        const username = btn.getAttribute('data-username');

        // Como sua API exige CPF, vamos pedir ao usuário (ou pegar do perfil se tiver)
        const cpf = prompt("Por favor, confirme seu CPF para finalizar o empréstimo (formato: 000.000.000-00):");
        
        if (!cpf) return; // Se cancelar, para tudo.

        // Calcular data de devolução (Data de hoje + 7 dias)
        const hoje = new Date();
        const dataDevolucao = new Date(hoje);
        dataDevolucao.setDate(hoje.getDate() + 7); 
        // Formata para YYYY-MM-DD
        const dataFormatada = dataDevolucao.toISOString().split('T')[0];

        // Prepara os dados para a API
        const dados = {
            livro: parseInt(bookId),
            nome_aluno: username,
            cpf_aluno: cpf,
            data_devolucao: dataFormatada
        };

        try {
            btn.disabled = true; // Evita clique duplo
            btn.textContent = "Processando...";

            const response = await fetch('http://127.0.0.1:8000/api/emprestimos/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Importante para segurança no Django
                },
                body: JSON.stringify(dados)
            });

            if (response.ok) {
                alert("Livro emprestado com sucesso!");
                // Redireciona para a Home para ver o livro lá
                window.location.href = "{% url 'virtuallibrary:home' %}";
            } else {
                const erro = await response.json();
                // Mostra o erro que veio da API (ex: "Sem estoque")
                alert("Erro ao emprestar: " + JSON.stringify(erro));
                btn.disabled = false;
                btn.textContent = "Pegar emprestado";
            }

        } catch (error) {
            console.error('Erro:', error);
            alert("Erro de conexão com a API.");
            btn.disabled = false;
            btn.textContent = "Pegar emprestado";
        }
    });

    // Função auxiliar para pegar o Token CSRF do Django
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}